<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.6.0.min.js"></script>
        <script src="https://ajax.aspnetcdn.com/ajax/jquery.ui/1.13.0/jquery-ui.min.js"></script>
        <script type="text/javascript">
            $(function()
            {
                // ソケット通信
                let socket;
                let json;
                function connect()
                {
                    try
                    {
                        socket = new WebSocket("ws://localhost:8000/StickyNotes.ashx");
                        socket.onopen = function()
                        {
                            //console.log("WebSocket onopen");
                            socket.send("");
                        };
                        socket.onclose = function()
                        {
                            //console.log("WebSocket onclose");
                            disconnect();
                        };
                        socket.onmessage = function(msg)
                        {
                            //console.log("WebSocket onmessage " + msg.data);
                            load(msg.data);
                            json = msg.data;
                        };
                    }
                    catch(ex)
                    {
                        alert(ex);
                    }
                }
                connect();
                
                // 切断
                function disconnect()
                {
                    $('#add').hide();
                    $('#download').hide();
                    $('#error').text("サーバーに接続できませんでした。しばらく時間をおいて再度お試しください。");
                    $('.note').remove();
                    connect();
                }
                
                // 初期化
                $(document).ready(function()
                {
                    set_option();
                    background($('#dialog_bg-image').val(), $('#dialog_bg-color').val());
                });
                
                // オプション反映
                function set_option()
                {
                    $('#dialog_grid').prop("checked", get_storage("Grid", "true").toLowerCase() == "true");
                    $('#dialog_bg-image').val(get_storage("Image", "none"));
                    $('#dialog_bg-color').val(get_storage("Color", "none"));
                }
                
                // ストレージ参照
                function get_storage(key, val)
                {
                    let item = localStorage.getItem(key);
                    if(item == null)
                    {
                        item = val;
                    }
                    return item;
                }
                
                // Addボタン設定
                $('#add').button(
                {
                    icons:
                    {
                        primary: "ui-icon-plus"
                    },
                    text: true
                });
                
                // Addボタン押下
                $('#add').click(function()
                {
                    let $note = add();
                    send('#' + $note.attr('id'));
                });
                
                // Optionボタン設定
                $('#option').button(
                {
                    icons:
                    {
                        primary: "ui-icon-gear"
                    },
                    text: true
                });
                
                // Optionボタン押下
                $('#option').click(function()
                {
                    set_option();
                    $('#dialog_option').dialog("open");
                });
                
                // 付箋紙の追加
                function add()
                {
                    let $note = $('<div class="note" id="note">' +
                                  '<div class="message">ダブルクリックで編集</div>' +
                                  '<a class="url" href="" target="_blank" rel="noopener noreferrer">LINK</a>' +
                                  '<input type="hidden" class="no" value="0" />' +
                                  '<input type="hidden" class="color" value="blue" />' +
                                  '<input type="hidden" class="timestamp" value="" />' +
                                  '<input type="hidden" class="delete" value="0" />' +
                                  '</div>');
                    $note.draggable(
                    {
                        stack: ".note",
                        stop: function(e, ui)
                        {
                            $(this).css('position', 'absolute');
                            $(this).css('top', ui.offset.top);
                            $(this).css('left', ui.offset.left);
                            grid('#' + $(this).attr('id'));
                            send('#' + $(this).attr('id'));
                        }
                    });
                    $note.resizable(
                    {
                        minWidth: 80,
                        minHeight: 40,
                        maxWidth: 800,
                        maxHeight: 400,
                        stop: function(e, ui)
                        {
                            grid('#' + $(this).attr('id'));
                            send('#' + $(this).attr('id'));
                        }
                    });
                    $note.dblclick(function()
                    {
                        if($(this).find('.no').val() != "0")
                        {
                            $('#dialog_message').val($(this).find('.message').text());
                            $('#dialog_url').val($(this).find('.url').attr('href'));
                            $('input:radio[name="dialog_color"]').val([$(this).find('.color').val()]);
                            $('#dialog_target').val($(this).attr('id'));
                            $('#dialog_timestamp').val($(this).find('.timestamp').val());
                            $('#dialog').dialog("open");
                        }
                    });
                    $note.find('.url').text(($note.find('.url').attr('href') == "")?"":"LINK");
                    $note.css('background-image', color($note.find('.color').val()));
                    $('#container').append($note);
                    return $note;
                }
                
                // 付箋紙の位置調整
                function grid(target)
                {
                    if($('#dialog_grid').prop("checked"))
                    {
                        $(target).css('top', Math.round($(target).position().top / 10) * 10);
                        $(target).css('left', Math.round($(target).position().left / 10) * 10);
                        $(target).width(Math.round($(target).width() / 10) * 10);
                        $(target).height(Math.round($(target).height() / 10) * 10);
                    }
                }
                
                // ダイアログ
                $('#dialog').dialog(
                {
                    autoOpen: false,
                    width: 400,
                    height: "auto",
                    modal: true,
                    resizable: false,
                    title: document.title,
                    buttons:
                    {
                        "更新": function()
                        {
                            let target = '#' + $('#dialog_target').val();
                            if($('#dialog_message').val().length > 1000)
                            {
                                alert("本文は1,000文字以内で入力してください。");
                                return;
                            }
                            if($('#dialog_url').val().length > 2083)
                            {
                                alert("URLは2,083文字以内で入力してください。");
                                return;
                            }
                            if($('#dialog_url').val() != "" && !$('#dialog_url').val().match(/^(ftp|http|https):\/\/[^ "]+$/))
                            {
                                alert("URLの入力形式に誤りがあります。");
                                return;
                            }
                            if($('#dialog_timestamp').val() != $(target).find('.timestamp').val())
                            {
                                alert("既に他のユーザーによって変更されています。操作を中止してください。");
                                return;
                            }
                            $(target).find('.message').text($('#dialog_message').val());
                            $(target).find('.url').attr('href', $('#dialog_url').val());
                            $(target).find('.url').text(($('#dialog_url').val() == "")?"":"LINK");
                            $(target).find('.color').val($('input:radio[name="dialog_color"]:checked').val());
                            $(target).css('background-image', color($('input:radio[name="dialog_color"]:checked').val()));
                            $(this).dialog("close");
                            send(target);
                        },
                        "削除": function()
                        {
                            let target = '#' + $('#dialog_target').val();
                            if($('#dialog_timestamp').val() != $(target).find('.timestamp').val())
                            {
                                alert("既に他のユーザーによって変更されています。操作を中止してください。");
                                return;
                            }
                            if(window.confirm("削除してもよろしいですか？"))
                            {
                                $(target).find('.delete').val("1");
                                $(this).dialog("close");
                                send(target);
                            }
                        },
                        "中止": function()
                        {
                            $(this).dialog("close");
                        }
                    }
                });
                
                // オプション
                $('#dialog_option').dialog(
                {
                    autoOpen: false,
                    width: 560,
                    height: "auto",
                    modal: true,
                    resizable: false,
                    title: "Option",
                    buttons:
                    {
                        "保存": function()
                        {
                            localStorage.setItem('Grid', $('#dialog_grid').prop("checked"));
                            localStorage.setItem('Image', $('#dialog_bg-image').val());
                            localStorage.setItem('Color', $('#dialog_bg-color').val());
                            background($('#dialog_bg-image').val(), $('#dialog_bg-color').val());
                            $(this).dialog("close");
                        },
                        "中止": function()
                        {
                            $(this).dialog("close");
                        }
                    }
                });
                
                // ダウンロード
                $('#dialog_download').click(function()
                {
                    let blob = new Blob([json], { type: "application\/json" });
                    if(window.navigator.msSaveBlob)
                    {
                        window.navigator.msSaveBlob(blob, "notes.json");
                    }
                    else
                    {
                        $('<a></a>', { href: window.URL.createObjectURL(blob), download: "notes.json", target: "_blank" })[0].click();
                    }
                });
                
                // 付箋紙の送信
                function send(target)
                {
                    if(!$(target)[0]) return;
                    let note =
                    {
                        message: $(target).find('.message').text(),
                        url: $(target).find('.url').attr('href'),
                        no: Number($(target).find('.no').val()),
                        color: $(target).find('.color').val(),
                        position: $(target).css('position'),
                        top: $(target).css('top'),
                        left: $(target).css('left'),
                        width: $(target).css('width'),
                        height: $(target).css('height'),
                        timestamp: $(target).find('.timestamp').val(),
                        delete: Number($(target).find('.delete').val())
                    }
                    socket.send(JSON.stringify(note));
                }
                
                // 付箋紙の読込
                function load(data)
                {
                    $('#add').show();
                    $('#download').show();
                    $('#error').text("");
                    $(".note").remove();
                    let notes = JSON.parse(data);
                    $.each(notes, function(index, val)
                    {
                        let $note = add();
                        $note.attr('id', 'note' + val.no);
                        $note.find('.message').text(val.message);
                        $note.find('.url').attr('href', val.url);
                        $note.find('.url').text((val.url == "")?"":"LINK");
                        $note.find('.no').val(val.no);
                        $note.find('.color').val(val.color);
                        $note.css('background-image', color(val.color));
                        $note.css('position', val.position);
                        $note.css('top', val.top);
                        $note.css('left', val.left);
                        $note.css('width', val.width);
                        $note.css('height', val.height);
                        $note.find('.timestamp').val(val.timestamp);
                        $note.find('.delete').val(val.delete);
                    });
                }
                
                // 付箋紙の背景色
                function color(val)
                {
                    let result = "";
                    switch(val)
                    {
                        case "blue":
                            result = "linear-gradient(180deg, hsla(0, 0%, 45%, 0.1) 2rem, hsla(0, 100%, 100%, 0) 2.5rem)," +
                                     "linear-gradient(180deg, hsla(200, 100%, 85%, 1), hsla(200, 100%, 85%, 1))";
                            break;
                        case "red":
                            result = "linear-gradient(180deg, hsla(0, 0%, 45%, 0.1) 2rem, hsla(0, 100%, 100%, 0) 2.5rem)," +
                                     "linear-gradient(180deg, hsla(0, 100%, 85%, 1), hsla(0, 100%, 85%, 1))";
                            break;
                        case "yellow":
                            result = "linear-gradient(180deg, hsla(0, 0%, 45%, 0.1) 2rem, hsla(0, 100%, 100%, 0) 2.5rem)," +
                                     "linear-gradient(180deg, hsla(60, 100%, 85%, 1), hsla(60, 100%, 85%, 1))";
                            break;
                        case "green":
                            result = "linear-gradient(180deg, hsla(0, 0%, 45%, 0.1) 2rem, hsla(0, 100%, 100%, 0) 2.5rem)," +
                                     "linear-gradient(180deg, hsla(120, 100%, 85%, 1), hsla(120, 100%, 85%, 1))";
                            break;
                        case "purple":
                            result = "linear-gradient(180deg, hsla(0, 0%, 45%, 0.1) 2rem, hsla(0, 100%, 100%, 0) 2.5rem)," +
                                     "linear-gradient(180deg, hsla(280, 100%, 85%, 1), hsla(280, 100%, 85%, 1))";
                            break;
                         case "orange":
                            result = "linear-gradient(180deg, hsla(0, 0%, 45%, 0.1) 2rem, hsla(0, 100%, 100%, 0) 2.5rem)," +
                                     "linear-gradient(180deg, hsla(30, 100%, 85%, 1), hsla(30, 100%, 85%, 1))";
                            break;
                    }
                    return result;
                }
                
                // 背景設定
                function background(val, clr)
                {
                    let bg_color = "";
                    switch(clr)
                    {
                        case "blue":
                            bg_color = "hsla(200, 100%, 95%, 1)";
                            break;
                        case "red":
                            bg_color = "hsla(0, 100%, 95%, 1)";
                            break;
                        case "yellow":
                            bg_color = "hsla(60, 100%, 90%, 1)";
                            break;
                        case "green":
                            bg_color = "hsla(120, 100%, 95%, 1)";
                            break;
                        case "purple":
                            bg_color = "hsla(280, 100%, 95%, 1)";
                            break;
                        case "orange":
                            bg_color = "hsla(30, 100%, 95%, 1)";
                            break;
                        default:
                            bg_color = "hsla(0, 0%, 95%, 1)";
                            break;
                    }
                    switch(val)
                    {
                        case "box":
                            $('body').css('background-image', 'linear-gradient(' + bg_color + ' 2px, transparent 2px), linear-gradient(to right, ' + bg_color + ' 2px, #fff 2px)');
                            $('body').css('background-size', '20px 20px');
                            break;
                        case "dot":
                            $('body').css('background-image', 'radial-gradient(' + bg_color + ' 2px, #fff 2px)');
                            $('body').css('background-size', '20px 20px');
                            break;
                        case "stripe":
                            $('body').css('background-image', 'repeating-linear-gradient(45deg, ' + bg_color + ' 0, ' + bg_color + ' 2px, #fff 0, #fff 50%)');
                            $('body').css('background-size', '20px 20px');
                            break;
                        default:
                            $('body').css('background-image', 'none');
                            $('body').css('background-size', 'auto');
                            break;
                    }
                }
            });
        </script>
        <style type="text/css">
            body
            {
                font-family: Verdana, Arial, sans-serif;
            }
            #add
            {
                z-index: 20;
            }
            #option
            {
                z-index: 20;
            }
            #error
            {
                color: red;
            }
            .note
            {
                width: 200px;
                height: 100px;
                padding: 40px 10px 20px 10px;
                overflow: hidden;
                box-shadow: 0 0.25rem 0.25rem hsla(0, 0%, 0%, 0.1);
                font-size: 1.0rem;
                white-space: pre-wrap;
                line-height: 1.4;
                cursor: pointer;
                z-index: 10;
            }
            .url
            {
                position: absolute;
                top: 2px;
                right: 10px;
            }
            #dialog
            {
                display: none;
                z-index: 30;
            }
            #dialog_message
            {
                width: 100%;
                resize: none;
            }
            #dialog_url
            {
                width: 100%;
            }
            .dialog_radio input[type="radio"]:not(:first-child)
            {
                margin-left: 24px;
            }
            #dialog_option
            {
                display: none;
                z-index: 30;
                line-height: 42px;
            }
        </style>
        <link rel="stylesheet" href="https://ajax.aspnetcdn.com/ajax/jquery.ui/1.13.0/themes/base/jquery-ui.css">
        <title>Sticky Notes</title>
    </head>
    <body>
        <button id="add">Add</button>
        <button id="option">Option</button>
        <div id="error"></div>
        <div id="container"></div>
        <div id="dialog">
            <form>
                <label for="dialog_message">本文</label><br>
                <textarea id="dialog_message" name="dialog_message" rows="5" ></textarea><br><br>
                <label for="dialog_url">URL</label><br>
                <input type="text" id="dialog_url" name="dialog_url" /><br><br>
                <div class="dialog_radio">
                    <input type="radio" id="dialog_blue" name="dialog_color" value="blue" />
                    <label for="dialog_blue">青</label>
                    <input type="radio" id="dialog_red" name="dialog_color" value="red" />
                    <label for="dialog_red">赤</label>
                    <input type="radio" id="dialog_yellow" name="dialog_color" value="yellow" />
                    <label for="dialog_yellow">黄</label>
                    <input type="radio" id="dialog_green" name="dialog_color" value="green" />
                    <label for="dialog_green">緑</label>
                    <input type="radio" id="dialog_purple" name="dialog_color" value="purple" />
                    <label for="dialog_purple">紫</label>
                    <input type="radio" id="dialog_orange" name="dialog_color" value="orange" />
                    <label for="dialog_orange">橙</label>
                </div>
                <input type="hidden" id="dialog_target" />
                <input type="hidden" id="dialog_timestamp" />
            </form>
        </div>
        <div id="dialog_option">
            <form>
                <div>以下の設定はローカルストレージに保存されます。</div>
                <span>【付箋】</span>
                <input type="checkbox" id="dialog_grid" name="dialog_grid" />
                <label for="dialog_grid">グリッドに沿って配置する。</label><br>
                <span>【背景】</span>
                <label for="dialog_bg-image">パターン：</label>
                <select id="dialog_bg-image">
                    <option value="none">なし</option>
                    <option value="box">ボックス</option>
                    <option value="dot">ドット</option>
                    <option value="stripe">ストライプ</option>
                </select>
                <label for="dialog_bg-color">　カラー：</label>
                <select id="dialog_bg-color">
                    <option value="none">なし</option>
                    <option value="blue">青</option>
                    <option value="red">赤</option>
                    <option value="yellow">黄</option>
                    <option value="green">緑</option>
                    <option value="purple">紫</option>
                    <option value="orange">橙</option>
                </select>
                <div>※JSONデータをダウンロードする場合は<a id="dialog_download" href="javascript:void(0);">ここ</a>をクリックしてください。</div>
            </form>
        </div>
    </body>
</html>